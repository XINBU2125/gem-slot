<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¶çŸ³æ‹‰éœ¸æ©Ÿ - è¦å‰‡å¼·åŒ–ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #ffd700; --purple: #d084ff; --red: #ff4d4d; --cyan: #00f2ff; --blue: #2b57ff; --bg: #121212; }
        body { background: var(--bg); color: white; font-family: 'Microsoft JhengHei', sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        .auth-box { background: #222; padding: 40px; border-radius: 15px; border: 2px solid var(--gold); text-align: center; margin-top: 50px; }
        #game-area { display: none; width: 1150px; grid-template-columns: 300px 1fr 280px; gap: 25px; }
        .panel { background: rgba(30,30,30,0.9); padding: 20px; border-radius: 12px; border: 1px solid #444; }
        #slot-grid { display: grid; grid-template-columns: repeat(5, 95px); gap: 12px; background: #000; padding: 20px; border: 5px solid #444; border-radius: 20px; position: relative; }
        .cell { width: 95px; height: 95px; background: #1a1a1a; border-radius: 10px; display: flex; align-items: center; justify-content: center; position: relative; border: 2px solid transparent; overflow: hidden; }
        .cell img { width: 85% !important; height: 85% !important; object-fit: contain !important; display: block; }
        
        /* è¦å‰‡è¦–çª—æ’ç‰ˆå„ªåŒ– */
        #rule-modal .panel { max-width: 500px; max-height: 85vh; overflow-y: auto; line-height: 1.6; }
        .rule-table { width: 100%; border-collapse: collapse; margin: 15px 0; background: #222; border-radius: 8px; overflow: hidden; }
        .rule-table th { background: #333; color: var(--gold); padding: 10px; font-size: 0.9rem; }
        .rule-table td { padding: 10px; border-bottom: 1px solid #444; text-align: center; }
        .effect-list { text-align: left; padding: 0 10px; }
        .effect-item { margin-bottom: 12px; border-bottom: 1px dashed #444; padding-bottom: 8px; }
        .effect-item b { color: var(--gold); }
        .txt-cyan { color: var(--cyan); } .txt-purple { color: var(--purple); }
        .txt-red { color: var(--red); } .txt-blue { color: var(--blue); }

        .score-pop { position: absolute; font-weight: bold; font-size: 5rem; top: 40%; left: 50%; transform: translate(-50%, -50%); animation: floatUpCentral 1.5s forwards; z-index: 999; text-shadow: 0 0 30px #000; pointer-events: none; white-space: nowrap; }
        @keyframes floatUpCentral { 0% { opacity: 0; transform: translate(-50%, -20%) scale(0.5); } 20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); } 100% { opacity: 0; transform: translate(-50%, -120%) scale(0.8); } }
        @media (max-width: 1100px) {
            #game-area { display: none; flex-direction: column !important; width: 100vw !important; padding: 10px 0 !important; gap: 15px !important; }
            .panel { width: 92vw !important; margin: 0 auto !important; }
            #slot-grid { grid-template-columns: repeat(5, 17vw) !important; width: 92vw !important; padding: 10px !important; gap: 1.5vw !important; margin: 0 auto !important; }
            .cell { width: 16vw !important; height: 16vw !important; }
            .score-pop { font-size: 3rem !important; }
        }
        .winning-cell { border-color: white !important; box-shadow: 0 0 20px white; background: #333 !important; z-index: 5; }
        button { padding: 12px 20px; background: var(--gold); border: none; cursor: pointer; font-weight: bold; border-radius: 6px; }
        button:disabled { background: #555; cursor: not-allowed; }
        .shaking { animation: shake 0.1s infinite; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -1px); } 100% { transform: translate(1px, -1px); } }
    </style>
</head>
<body>

    <div id="rule-btn" onclick="toggleRules()" style="position:fixed; top:20px; left:20px; width:45px; height:45px; background:var(--gold); color:black; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:1.5rem; cursor:pointer; z-index:1000; box-shadow: 0 0 10px rgba(255,215,0,0.5);">?</div>

    <div id="rule-modal" onclick="toggleRules()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; justify-content:center; align-items:center; padding:20px;">
        <div class="panel" style="border:2px solid var(--gold);" onclick="event.stopPropagation()">
            <h2 style="color:var(--gold); text-align:center; margin-top:0;">ğŸ’ éŠæˆ²è¦å‰‡èˆ‡å€ç‡</h2>
            
            <table class="rule-table">
                <tr><th>å¯¶çŸ³ç¨®é¡</th><th>3é€£</th><th>4é€£</th><th>5é€£</th></tr>
                <tr><td class="txt-cyan">é‘½çŸ³</td><td>200</td><td>300</td><td>600</td></tr>
                <tr><td class="txt-purple">ç´«æ°´æ™¶</td><td>25</td><td>45</td><td>75</td></tr>
                <tr><td class="txt-red">å°–æ™¶çŸ³</td><td>10</td><td>20</td><td>40</td></tr>
                <tr><td class="txt-blue">å¤©é’çŸ³</td><td>10</td><td>20</td><td>40</td></tr>
                <tr><td>çç </td><td>20</td><td>30</td><td>40</td></tr>
            </table>

            <h3 style="color:var(--gold); border-left:4px solid var(--gold); padding-left:10px;">âœ¨ ç‰¹æ®Šæ•ˆæœèªªæ˜</h3>
            <div class="effect-list">
                <div class="effect-item">
                    <b>ğŸ’§ å¤©é’çŸ³ï¼š</b>ä»»ä½•å½¢å¼çš„é€£ç·šé”æˆï¼Œé¡å¤–ç²å¾— <b>+1 æ¬¡è½‰å‹•æ©Ÿæœƒ</b>ã€‚
                </div>
                <div class="effect-item">
                    <b>â™¦ï¸ å°–æ™¶çŸ³ï¼š</b>ä¸­çæ™‚ï¼Œç¸½åˆ†é¡å¤–åŠ æˆã€‚æ¯å¤šä¸€çµ„ä¸­çé€£ç·šï¼Œç¸½å¾—åˆ† <b>+10%</b>ã€‚
                </div>
                <div class="effect-item">
                    <b>ğŸ”® ç´«æ°´æ™¶ï¼š</b>è‹¥ç•¶æ¬¡æ—‹è½‰ã€Œåƒ…æœ‰ã€ç´«æ°´æ™¶é”æˆé€£ç·šï¼Œè©²æ¬¡ç¸½å¾—åˆ† <b>ç›´æ¥ç¿»å€ (x2)</b>ã€‚
                </div>
                <div class="effect-item">
                    <b>ğŸ“ é€£ç·šè¦å‰‡ï¼š</b>æ©«å‘é€£ç·šä¾é•·åº¦è¨ˆåˆ†ï¼ˆå–æœ€é«˜é€£ç·šï¼Œä¸é‡è¤‡è¨ˆç®—ï¼‰ï¼›ç¸±å‘èˆ‡æ–œå‘å›ºå®šåƒ…è¨ˆç®— <b>3é€£ç·š</b>ã€‚
                </div>
            </div>

            <button onclick="toggleRules()" style="width:100%; margin-top:10px; font-size:1.1rem;">æˆ‘äº†è§£äº†</button>
        </div>
    </div>

    <div id="login-screen" class="auth-box">
        <h2 style="color:var(--gold);">ğŸ’ å¯¶çŸ³æ‹‰éœ¸æ©Ÿ</h2>
        <input type="text" id="user-in" placeholder="å¸³è™Ÿ" style="padding:10px; margin:10px;"><br>
        <input type="password" id="pass-in" placeholder="å¯†ç¢¼" style="padding:10px; margin:10px;"><br>
        <button onclick="handleLogin()">é–‹å§‹éŠæˆ²</button>
    </div>

    <div id="game-area">
        <div style="display:flex; flex-direction:column; gap:20px;">
            <div class="panel">
                <h3>ğŸ¯ ä»»å‹™ç´€éŒ„</h3>
                <textarea id="m-content" placeholder="è¼¸å…¥å…§å®¹..." style="width:95%; height:60px; background:#111; color:white; padding:10px; border:1px solid #444;"></textarea>
                <button onclick="addMission('small')" style="width:100%; margin-top:10px;">å°ç›®æ¨™ (+1è½‰)</button>
                <button onclick="addMission('big')" style="width:100%; margin-top:10px; background:#b8860b;">å¤§æˆå°± (+5è½‰)</button>
                <div id="mission-list" style="margin-top:15px; font-size: 0.85rem; height: 250px; overflow-y: auto;"></div>
            </div>
        </div>

        <div style="text-align: center;">
            <div id="guarantee-msg" style="color:#ffeb3b; font-weight:bold; visibility:hidden; font-size: 0.9rem;">â­ ä»Šæ—¥é¦–è½‰ä¿åº•</div>
            <div style="margin-bottom:10px;">
                <span style="color:#aaa;">ç¸½ç©åˆ†</span>
                <div id="point-display" style="color:var(--gold); font-size: 3rem; font-weight:bold;">0</div>
            </div>
            <div id="slot-grid"></div>
            <button id="spin-btn" onclick="processSpin()" style="margin-top:20px; font-size: 1.8rem; width: 100%; height: 70px;">ğŸ° é–‹å§‹è½‰å‹•</button>
            <button onclick="handleWithdraw()" style="background:#444; color:white; width: 100%; margin-top:10px;">æé ˜åˆ†æ•¸</button>
        </div>

        <div class="panel">
            <div style="background:#222; padding:15px; border-radius:10px; margin-bottom:10px;">
                <div>å‰©é¤˜è½‰å‹•</div>
                <div id="spin-count" style="font-size:2rem; font-weight:bold;">0</div>
            </div>
            <div style="background:#222; padding:15px; border-radius:10px; color:var(--cyan); border:1px solid var(--cyan);">
                <div>é¡å¤–æ©Ÿæœƒ</div>
                <div id="extra-count" style="font-size:2rem; font-weight:bold;">0</div>
            </div>
            <div id="game-log" style="margin-top:15px; height: 150px; overflow-y: auto; font-size: 0.75rem; color:#888; border-top:1px solid #333; padding-top:10px;">> ç´€éŒ„å€...</div>
        </div>
    </div>

<script>
// æ­¤è™•ä¿ç•™ä½ ç›®å‰çš„æ‰€æœ‰ JavaScript (SB_URL, SYMBOLS, analyzeGrid, calculateScore ç­‰)
// è«‹å°‡ä½ åŸæœ¬ SYMBOLS ä¸­çš„åœ–ç‰‡ç¶²å€å†æ¬¡è²¼å…¥å³å¯ã€‚
const SB_URL = "https://knasaqqsqofcskazalwf.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtuYXNhcXFzcW9mY3NrYXphbHdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5MTcxNTksImV4cCI6MjA4NzQ5MzE1OX0.TxpnxsEGd6L2aBfHn2FttPFXtMyk3VeM44IgyzheTpU";
const _sb = supabase.createClient(SB_URL, SB_KEY);

const SYMBOLS = [
    { id: 0, name: 'ğŸ’', img: "https://knasaqqsqofcskazalwf.supabase.co/storage/v1/object/public/game-assets/diamond.PNG", prob: 0.10, p3: 200, p4: 300, p5: 600, label: 'é‘½çŸ³', color: '#00f2ff' },
    { id: 1, name: 'ğŸ”®', img: "https://knasaqqsqofcskazalwf.supabase.co/storage/v1/object/public/game-assets/Amethyst.PNG", prob: 0.22, p3: 25,  p4: 45,  p5: 75,  label: 'ç´«æ°´æ™¶', color: '#d084ff' },
    { id: 2, name: 'â™¦ï¸', img: "https://knasaqqsqofcskazalwf.supabase.co/storage/v1/object/public/game-assets/Spinel.PNG", prob: 0.17, p3: 10,  p4: 20,  p5: 40,  label: 'å°–æ™¶çŸ³', color: '#ff4d4d' },
    { id: 3, name: 'ğŸ’§', img: "https://knasaqqsqofcskazalwf.supabase.co/storage/v1/object/public/game-assets/Celestite.PNG", prob: 0.17, p3: 10,  p4: 20,  p5: 40,  label: 'å¤©é’çŸ³', color: '#2b57ff' },
    { id: 4, name: 'âšª', img: "https://knasaqqsqofcskazalwf.supabase.co/storage/v1/object/public/game-assets/pearl.PNG", prob: 0.34, p3: 20,  p4: 30,  p5: 40,  label: 'çç ', color: '#eee' }
];

let userData = null; let isBusy = false; let isFirstSpinToday = false;

function toggleRules() {
    const m = document.getElementById('rule-modal');
    m.style.display = (m.style.display === 'none' || m.style.display === '') ? 'flex' : 'none';
}

async function handleLogin() {
    const user = document.getElementById('user-in').value.trim();
    const pass = document.getElementById('pass-in').value.trim();
    if(!user || !pass) return;
    try {
        let { data } = await _sb.from('player_stats').select('*').eq('username', user).maybeSingle();
        if(!data) {
            const { data: n } = await _sb.from('player_stats').insert([{ username: user, password: pass, total_points: 0, spins: 0, extra_spins: 0, last_play_date: new Date() }]).select().single();
            userData = n;
        } else {
            if(data.password !== pass) return alert("å¯†ç¢¼éŒ¯èª¤");
            userData = data;
        }
        checkDaily();
        document.getElementById('login-screen').style.display = 'none';
        updateAreaLayout(); initGrid(); loadMissions(); updateUI();
    } catch (e) { console.error(e); }
}

function updateAreaLayout() {
    const gameArea = document.getElementById('game-area');
    gameArea.style.display = window.innerWidth <= 1100 ? 'flex' : 'grid';
}

function checkDaily() {
    const today = new Date().toLocaleDateString();
    const last = new Date(userData.last_play_date).toLocaleDateString();
    if (today !== last) { isFirstSpinToday = true; document.getElementById('guarantee-msg').style.visibility = 'visible'; }
}

function initGrid() {
    const g = document.getElementById('slot-grid'); g.innerHTML = '';
    for(let i=0; i<15; i++) {
        const d = document.createElement('div'); d.className = 'cell'; d.id = `c-${i}`; d.innerText = 'â“';
        g.appendChild(d);
    }
}

function renderCell(idx, symbol) {
    const cell = document.getElementById(`c-${idx}`);
    if (symbol.img && symbol.img.includes("http")) {
        cell.innerHTML = `<img src="${symbol.img}" crossorigin="anonymous" onerror="this.style.display='none'; this.nextSibling.style.display='block';" alt="${symbol.label}"><span style="display:none; color:${symbol.color}; font-size:2.5rem;">${symbol.name}</span>`;
    } else {
        cell.innerHTML = `<span style="color:${symbol.color}; font-size:2.5rem;">${symbol.name}</span>`;
    }
}

async function processSpin() {
    if(isBusy) return;
    if(!isFirstSpinToday && userData.spins <= 0 && userData.extra_spins <= 0) return alert("æ¬¡æ•¸ä¸è¶³ï¼");
    isBusy = true;
    const btn = document.getElementById('spin-btn');
    btn.disabled = true; btn.innerText = "æ—‹è½‰ä¸­...";
    document.querySelectorAll('.cell').forEach(c => c.classList.remove('winning-cell'));
    const gridEl = document.getElementById('slot-grid');
    gridEl.classList.add('shaking');
    const interval = setInterval(() => { for(let i=0; i<15; i++) renderCell(i, SYMBOLS[Math.floor(Math.random()*5)]); }, 80);
    await new Promise(r => setTimeout(r, 1200));
    clearInterval(interval);
    gridEl.classList.remove('shaking');
    let winMatches = [], finalGrid = [];
    while(true) {
        finalGrid = Array.from({length: 15}, () => {
            let r = Math.random(), s = 0;
            for(let sym of SYMBOLS) { s += sym.prob; if(r <= s) return sym; }
            return SYMBOLS[4];
        });
        winMatches = analyzeGrid(finalGrid);
        if (!isFirstSpinToday || winMatches.length > 0) break;
    }
    if(isFirstSpinToday) { isFirstSpinToday = false; document.getElementById('guarantee-msg').style.visibility = 'hidden'; }
    else { if(userData.extra_spins > 0) userData.extra_spins--; else userData.spins--; }
    for(let i=0; i<15; i++) renderCell(i, finalGrid[i]);
    await calculateScore(finalGrid, winMatches);
    isBusy = false; btn.disabled = false; btn.innerText = "ğŸ° é–‹å§‹è½‰å‹•";
    updateUI();
}

function analyzeGrid(grid) {
    const wins = [];
    const rowStarts = [0, 5, 10];
    rowStarts.forEach(start => {
        const row = [start, start+1, start+2, start+3, start+4];
        const ids = row.map(idx => grid[idx].id);
        let foundRowWin = false;
        if (ids[0]===ids[1] && ids[1]===ids[2] && ids[2]===ids[3] && ids[3]===ids[4]) {
            const sym = grid[row[0]]; wins.push({ pts: sym.p5, id: sym.id, cells: row, label: sym.label, count: 5 });
            foundRowWin = true;
        } 
        if (!foundRowWin) {
            for (let i = 0; i <= 1; i++) {
                if (ids[i]===ids[i+1] && ids[i+1]===ids[i+2] && ids[i+2]===ids[i+3]) {
                    const sym = grid[row[i]]; wins.push({ pts: sym.p4, id: sym.id, cells: row.slice(i, i+4), label: sym.label, count: 4 });
                    foundRowWin = true; break;
                }
            }
        }
        if (!foundRowWin) {
            for (let i = 0; i <= 2; i++) {
                if (ids[i]===ids[i+1] && ids[i+1]===ids[i+2]) {
                    const sym = grid[row[i]]; wins.push({ pts: sym.p3, id: sym.id, cells: row.slice(i, i+3), label: sym.label, count: 3 });
                    foundRowWin = true; break;
                }
            }
        }
    });
    for (let c = 0; c < 5; c++) {
        if (grid[c].id === grid[c+5].id && grid[c].id === grid[c+10].id) wins.push({ pts: grid[c].p3, id: grid[c].id, cells: [c, c+5, c+10], label: grid[c].label, count: 3 });
    }
    for (let c = 0; c <= 2; c++) {
        if (grid[c].id === grid[c+6].id && grid[c].id === grid[c+12].id) wins.push({ pts: grid[c].p3, id: grid[c].id, cells: [c, c+6, c+12], label: grid[c].label, count: 3 });
        let tr = c + 2;
        if (grid[tr].id === grid[tr+4].id && grid[tr].id === grid[tr+8].id) wins.push({ pts: grid[tr].p3, id: grid[tr].id, cells: [tr, tr+4, tr+8], label: grid[tr].label, count: 3 });
    }
    return wins;
}

async function calculateScore(grid, wins) {
    let baseScore = 0, spinelCount = 0;
    const amethystOnly = wins.length > 0 && wins.every(w => w.id === 1);
    for (const win of wins) {
        win.cells.forEach(idx => document.getElementById(`c-${idx}`).classList.add('winning-cell'));
        if(win.id === 3) userData.extra_spins++;
        if(win.id === 2) spinelCount++;
        baseScore += win.pts;
        showPop(win.pts, SYMBOLS[win.id].color);
        addLog(`${win.label}${win.count}é€£ (+${win.pts})`);
        await new Promise(r => setTimeout(r, 600));
    }
    let finalAdded = baseScore;
    if (spinelCount > 0 && baseScore > 0) {
        let bonus = Math.round(baseScore * 0.1 * wins.length);
        finalAdded += bonus; showPop(bonus, 'var(--red)'); addLog(`å°–æ™¶çŸ³åŠ æˆ (+${bonus})`);
        await new Promise(r => setTimeout(r, 500));
    }
    if (amethystOnly && baseScore > 0) {
        let double = finalAdded;
        finalAdded += double; showPop(double, 'var(--purple)'); addLog(`ç´«æ°´æ™¶ç¨ä½”ç¿»å€ (+${double})`);
        await new Promise(r => setTimeout(r, 500));
    }
    userData.total_points += finalAdded; await syncData(); updateUI();
}

function showPop(val, color) {
    const e = document.createElement('div'); e.className = 'score-pop'; e.style.color = color; e.innerText = `+${val}`;
    document.getElementById('slot-grid').appendChild(e); setTimeout(() => e.remove(), 1500);
}

function updateUI() {
    if(!userData) return;
    document.getElementById('point-display').innerText = userData.total_points.toLocaleString();
    document.getElementById('spin-count').innerText = userData.spins;
    document.getElementById('extra-count').innerText = userData.extra_spins;
}

async function syncData() {
    await _sb.from('player_stats').update({ total_points: userData.total_points, spins: userData.spins, extra_spins: userData.extra_spins, last_play_date: new Date().toISOString() }).eq('username', userData.username);
}

async function addMission(type) {
    const val = document.getElementById('m-content').value; if(!val) return;
    const enc = btoa(encodeURIComponent(val));
    await _sb.from('missions').insert([{ username: userData.username, type, encrypted: enc, created_at: new Date().toISOString() }]);
    if(type === 'small') userData.spins += 1; else userData.spins += 5;
    document.getElementById('m-content').value = ''; syncData(); updateUI(); loadMissions();
}

async function loadMissions() {
    let { data } = await _sb.from('missions').select('*').eq('username', userData.username).order('created_at', {ascending: false});
    const list = document.getElementById('mission-list'); list.innerHTML = '';
    const groups = {};
    data.forEach(m => {
        const d = new Date(m.created_at).toLocaleDateString();
        if(!groups[d]) groups[d] = []; groups[d].push(m);
    });
    for(let d in groups) {
        let h = `<div style="margin-top:10px; border-left:3px solid var(--gold); padding-left:10px;"><div style="color:var(--gold); font-size:0.8rem; font-weight:bold;">${d}</div>`;
        groups[d].forEach(m => { h += `<div style="padding:2px 0; border-bottom:1px solid #222; font-size:0.8rem;">[${m.type==='big'?'æˆå°±':'ä»»å‹™'}] ${decodeURIComponent(atob(m.encrypted))}</div>`; });
        list.innerHTML += h + `</div>`;
    }
}

function handleWithdraw() {
    const v = prompt("è¼¸å…¥æé ˜åˆ†æ•¸:"); const a = parseInt(v);
    if(a > 0 && a <= userData.total_points) { userData.total_points -= a; syncData(); updateUI(); alert("æé ˜æˆåŠŸï¼"); }
}

function addLog(m) { const l = document.getElementById('game-log'); l.innerHTML = `<div>> ${m}</div>` + l.innerHTML; }
window.addEventListener('resize', () => { if(userData) updateAreaLayout(); });
</script>
</body>
</html>
